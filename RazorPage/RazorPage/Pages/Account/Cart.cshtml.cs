
using EmailService;
using Microsoft.AspNetCore.Hosting;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using Microsoft.EntityFrameworkCore;
using Microsoft.Reporting.NETCore;
using RazorPage.Data;
using RazorPage.Model;
using System.Collections.Generic;
using System.Data;
using System.Security.Principal;
using System.Text.Json;

namespace RazorPage.Pages.Account
{
    public class CartModel : PageModel
    {
        public class Item
        {
            public Model.Product Product { get; set; }
            public int Quantity { get; set; }
        }

        public double Total { get; set; }

        private readonly IEmailSender _emailSender;
        private readonly OrderService orderService = new OrderService();
        private readonly IWebHostEnvironment _webHostEnvironment;
        private readonly PRN221_DBContext dBContext;
        public CartModel(PRN221_DBContext dBContext, IWebHostEnvironment webHostEnvironment, IEmailSender emailSender)
        {
            this.dBContext = dBContext;
            _webHostEnvironment = webHostEnvironment;
            System.Text.Encoding.RegisterProvider(System.Text.CodePagesEncodingProvider.Instance);
            _emailSender = emailSender;
        }

        public IList<Model.Product> Product { get; set; }

        public List<Item> MyCart;

        [BindProperty]
        public Model.Customer Customer { get; set; }

        [BindProperty]
        public Model.Order Order { get; set; }

        public void OnGet()
        {
            if (HttpContext.Session.GetString("cart") != null)
            {
                MyCart = JsonSerializer.Deserialize<List<Item>>(HttpContext.Session.GetString("cart"));
                Total = MyCart.Sum(i => (double)i.Product.UnitPrice * i.Quantity);
            }
            else
            {
                MyCart = null;
                Total = 0;
            }

            String json = HttpContext.Session.GetString("CusSession");
            if (json == null)
            {
                RedirectToPage("/index");
            }
            else
            {
                Model.Account acc = JsonSerializer.Deserialize<Model.Account>(json);
                Customer =  dBContext.Customers.First(a => a.CustomerId == acc.CustomerId);
                if (Customer == null)
                {
                    RedirectToPage("/index");
                }
            }
        }


        public IActionResult OnGetBuy(int id)
        {
            List<Item> cart = null;
            var product = dBContext.Products.Find(id);
            String cart_session = HttpContext.Session.GetString("cart");
            if(cart_session != null)
            {
                cart = JsonSerializer.Deserialize<List<Item>>(cart_session);
            }
            if(cart == null)
            {
                cart = new List<Item>();
                cart.Add(new Item()
                {
                    Product = product,
                    Quantity = 1,
                });
                //CookieOptions option = new CookieOptions();
                //option.Expires = DateTime.Now.AddDays(30);
                //Response.Cookies.Append("cart", JsonSerializer.Serialize(cart), option);
                //var c = Request.Cookies["cart"];
                HttpContext.Session.SetString("cart", JsonSerializer.Serialize(cart));

            }
            else
            {
                var index = Exists(cart, id);
                if(index == -1)
                {
                    cart.Add(new Item()
                    {
                        Product = product,
                        Quantity = 1,
                    });
                }
                else
                {
                    var newQuantity = cart[index].Quantity + 1;
                    cart[index].Quantity = newQuantity;
                }
                HttpContext.Session.SetString("cart", JsonSerializer.Serialize(cart));
            }
            return RedirectToPage("/account/cart");
        }

        public async Task<IActionResult> OnGetAdd(int id)
        {
            MyCart = JsonSerializer.Deserialize<List<Item>>(HttpContext.Session.GetString("cart"));
            var CurProduct = await dBContext.Products.Where(cp => cp.ProductId == id).FirstOrDefaultAsync();
            int index = Exists(MyCart, id);
            if (index != -1)
            {
                MyCart[index].Quantity++;
            }
            HttpContext.Session.SetString("cart", JsonSerializer.Serialize(MyCart));
            return RedirectToPage("/account/cart");
        }

        public async Task<IActionResult> OnGetMinus(int id)
        {
            MyCart = JsonSerializer.Deserialize<List<Item>>(HttpContext.Session.GetString("cart"));
            int index = Exists(MyCart, id);
            if (index != -1)
            {
                if (MyCart[index].Quantity > 0)
                {
                    MyCart[index].Quantity--;
                }
            }
            HttpContext.Session.SetString("cart", JsonSerializer.Serialize(MyCart));
            return RedirectToPage("/account/cart");
        }

        public IActionResult OnGetDelete(int id)
        {
            String cart_session = HttpContext.Session.GetString("cart");
            var cart = JsonSerializer.Deserialize<List<Item>>(cart_session);
            var index = Exists(cart, id);
            cart.RemoveAt(index);
            HttpContext.Session.SetString("cart", JsonSerializer.Serialize(cart));
            return RedirectToPage("/account/cart");
        }

        private int Exists(List<Item> cart, int id)
        {
            for(int i = 0; i < cart.Count; i++)
            {
                if (cart[i].Product.ProductId.Equals(id))
                {
                    return i;
                }
            }
            return -1;
        }

        public async Task<IActionResult> OnPostAsync()
        {
            var CartSession = HttpContext.Session.GetString("cart");
            if (CartSession != null)
            {
                MyCart = JsonSerializer.Deserialize<List<Item>>(CartSession);
                Total = MyCart.Sum(i => (double)i.Product.UnitPrice * i.Quantity);
            }
                if (!ModelState.IsValid)
                {
                    return Page();
                }
            String json = HttpContext.Session.GetString("CusSession");
            
                var order = new Order
                {
                    CustomerId = Customer.CustomerId,
                    OrderDate = DateTime.Now,
                    RequiredDate = DateTime.Now,
                    ShipName = Customer.ContactName,
                    ShipAddress = Customer.Address,
                    Freight = (decimal)Total
                };
            if(json == null)
            {
                order = new Order
                {
                    CustomerId = null,
                    OrderDate = DateTime.Now,
                    RequiredDate = DateTime.Now,
                    ShipName = Customer.ContactName,
                    ShipAddress = Customer.Address,
                    Freight = (decimal)Total
                };
            }
            await dBContext.Orders.AddAsync(order);
            await dBContext.SaveChangesAsync();
            var newestOrder = await dBContext.Orders.OrderByDescending(p => p.OrderId).FirstOrDefaultAsync();
            
            if(MyCart != null)
            {
                foreach (var item in MyCart)
                {
                    if (item.Product.UnitsInStock >= item.Quantity)
                    {
                        var product = await dBContext.Products.Where(p => p.ProductId == item.Product.ProductId).FirstOrDefaultAsync();
                        product.UnitsInStock -= (short?)item.Quantity;

                        var orderDetail = new OrderDetail
                        {
                            OrderId = newestOrder.OrderId,
                            ProductId = item.Product.ProductId,
                            UnitPrice = (decimal)item.Product.UnitPrice,
                            Quantity = (short)item.Quantity,
                            Discount = 0
                        };
                        await dBContext.OrderDetails.AddAsync(orderDetail);
                    }
                    else
                    {
                        ViewData["msg"] = "Order failed! Not enough unit in stock";
                        dBContext.Orders.Remove(newestOrder);
                    }
                }
            }

            if (await dBContext.SaveChangesAsync() > 0)
            {
                HttpContext.Session.Remove("cart");
            }
            else
            {
                dBContext.Orders.Remove(newestOrder);
            }


            return OrderReport("PDF", "pdf", "application/pdf");
        }

        public IActionResult OrderReport(string renderFormat, string extension, string mimeType)
        {
            var newestOrder = dBContext.Orders.OrderByDescending(p => p.OrderId).FirstOrDefault();
            var get_order = dBContext.OrderDetails.OrderByDescending(p => p.OrderId).Where(p => p.OrderId == newestOrder.OrderId).Include(x => x.Product).ToList();
            var get_account = dBContext.Accounts.Where(x => x.CustomerId == newestOrder.CustomerId).FirstOrDefault();
            using var report = new LocalReport();
            var dt = new DataTable();
            dt = GetOrderList();

            report.DataSources.Add(new ReportDataSource("dsOrder", dt));
            var parameters = new[]{
                new ReportParameter("date", DateTime.Now.ToString("dddd, dd MMMM yyyy")),
                new ReportParameter("order", newestOrder.OrderId.ToString()),
                new ReportParameter("cusName", newestOrder.ShipName),
                new ReportParameter("cusEmail", get_account.Email),
                new ReportParameter("cusAddress", newestOrder.ShipAddress),
                new ReportParameter("totalDue",newestOrder.Freight.ToString() + "$"),


            };

            report.ReportPath = $"{_webHostEnvironment.WebRootPath}\\Reports\\rptOrder.rdlc";
            report.SetParameters(parameters);
            report.SubreportProcessing += new SubreportProcessingEventHandler(SubReportProcessing);

            string html = "\r\n<!DOCTYPE HTML PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional //EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\r\n<html xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:v=\"urn:schemas-microsoft-com:vml\" xmlns:o=\"urn:schemas-microsoft-com:office:office\">\r\n\r\n<head>\r\n    <!--[if gte mso 9]>\r\n<xml>\r\n  <o:OfficeDocumentSettings>\r\n    <o:AllowPNG/>\r\n    <o:PixelsPerInch>96</o:PixelsPerInch>\r\n  </o:OfficeDocumentSettings>\r\n</xml>\r\n<![endif]-->\r\n    <meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\">\r\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n    <meta name=\"x-apple-disable-message-reformatting\">\r\n    <!--[if !mso]><!-->\r\n    <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\">\r\n    <!--<![endif]-->\r\n    <title></title>\r\n\r\n    <style type=\"text/css\">\r\n        @media only screen and (min-width: 620px) {\r\n            .u-row {\r\n                width: 600px !important;\r\n            }\r\n            .u-row .u-col {\r\n                vertical-align: top;\r\n            }\r\n            .u-row .u-col-33p33 {\r\n                width: 199.98px !important;\r\n            }\r\n            .u-row .u-col-50 {\r\n                width: 300px !important;\r\n            }\r\n            .u-row .u-col-66p67 {\r\n                width: 400.02px !important;\r\n            }\r\n            .u-row .u-col-100 {\r\n                width: 600px !important;\r\n            }\r\n        }\r\n        \r\n        @media (max-width: 620px) {\r\n            .u-row-container {\r\n                max-width: 100% !important;\r\n                padding-left: 0px !important;\r\n                padding-right: 0px !important;\r\n            }\r\n            .u-row .u-col {\r\n                min-width: 320px !important;\r\n                max-width: 100% !important;\r\n                display: block !important;\r\n            }\r\n            .u-row {\r\n                width: calc(100% - 40px) !important;\r\n            }\r\n            .u-col {\r\n                width: 100% !important;\r\n            }\r\n            .u-col>div {\r\n                margin: 0 auto;\r\n            }\r\n        }\r\n        \r\n        body {\r\n            margin: 0;\r\n            padding: 0;\r\n        }\r\n        \r\n        table,\r\n        tr,\r\n        td {\r\n            vertical-align: top;\r\n            border-collapse: collapse;\r\n        }\r\n        \r\n        p {\r\n            margin: 0;\r\n        }\r\n        \r\n        .ie-container table,\r\n        .mso-container table {\r\n            table-layout: fixed;\r\n        }\r\n        \r\n        * {\r\n            line-height: inherit;\r\n        }\r\n        \r\n        a[x-apple-data-detectors='true'] {\r\n            color: inherit !important;\r\n            text-decoration: none !important;\r\n        }\r\n        \r\n        table,\r\n        td {\r\n            color: #000000;\r\n        }\r\n    </style>\r\n\r\n\r\n\r\n    <!--[if !mso]><!-->\r\n    <link href=\"https://fonts.googleapis.com/css2?family=Ubuntu:wght@300&display=swap\" rel=\"stylesheet\" type=\"text/css\">\r\n    <link href=\"https://fonts.googleapis.com/css?family=Lato:400,700&display=swap\" rel=\"stylesheet\" type=\"text/css\">\r\n    <!--<![endif]-->\r\n\r\n</head>\r\n\r\n<body class=\"clean-body u_body\" style=\"margin: 0;padding: 0;-webkit-text-size-adjust: 100%;background-color: #707070;color: #000000\">\r\n    <!--[if IE]><div class=\"ie-container\"><![endif]-->\r\n    <!--[if mso]><div class=\"mso-container\"><![endif]-->\r\n    <table style=\"border-collapse: collapse;table-layout: fixed;border-spacing: 0;mso-table-lspace: 0pt;mso-table-rspace: 0pt;vertical-align: top;min-width: 320px;Margin: 0 auto;background-color: #707070;width:100%\" cellpadding=\"0\" cellspacing=\"0\">\r\n        <tbody>\r\n            <tr style=\"vertical-align: top\">\r\n                <td style=\"word-break: break-word;border-collapse: collapse !important;vertical-align: top\">\r\n                    <!--[if (mso)|(IE)]><table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\"><tr><td align=\"center\" style=\"background-color: #707070;\"><![endif]-->\r\n\r\n\r\n                    <div class=\"u-row-container\" style=\"padding: 29px 10px 0px;background-color: rgba(255,255,255,0)\">\r\n                        <div class=\"u-row\" style=\"Margin: 0 auto;min-width: 320px;max-width: 600px;overflow-wrap: break-word;word-wrap: break-word;word-break: break-word;background-color: #17c297;\">\r\n                            <div style=\"border-collapse: collapse;display: table;width: 100%;height: 100%;background-color: transparent;\">\r\n                                <!--[if (mso)|(IE)]><table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\"><tr><td style=\"padding: 29px 10px 0px;background-color: rgba(255,255,255,0);\" align=\"center\"><table cellpadding=\"0\" cellspacing=\"0\" border=\"0\" style=\"width:600px;\"><tr style=\"background-color: #17c297;\"><![endif]-->\r\n\r\n                                <!--[if (mso)|(IE)]><td align=\"center\" width=\"200\" style=\"width: 200px;padding: 0px;border-top: 0px solid transparent;border-left: 0px solid transparent;border-right: 0px solid transparent;border-bottom: 0px solid transparent;\" valign=\"top\"><![endif]-->\r\n                                <div class=\"u-col u-col-33p33\" style=\"max-width: 320px;min-width: 200px;display: table-cell;vertical-align: top;\">\r\n                                    <div style=\"height: 100%;width: 100% !important;\">\r\n                                        <!--[if (!mso)&(!IE)]><!-->\r\n                                        <div style=\"height: 100%; padding: 0px;border-top: 0px solid transparent;border-left: 0px solid transparent;border-right: 0px solid transparent;border-bottom: 0px solid transparent;\">\r\n                                            <!--<![endif]-->\r\n\r\n                                            <table style=\"font-family:'Lato',sans-serif;\" role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" border=\"0\">\r\n                                                <tbody>\r\n                                                    <tr>\r\n                                                        <td style=\"overflow-wrap:break-word;word-break:break-word;padding:20px;font-family:'Lato',sans-serif;\" align=\"left\">\r\n\r\n                                                            <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">\r\n                                                                <tr>\r\n                                                                    <td style=\"padding-right: 0px;padding-left: 0px;\" align=\"center\">\r\n\r\n                                                                        <img align=\"center\" border=\"0\" src=\"https://ucarecdn.com/71d9fe48-bded-4265-96c9-9865f1f18a1a/\" alt=\"Image\" title=\"Image\" style=\"outline: none;text-decoration: none;-ms-interpolation-mode: bicubic;clear: both;display: inline-block !important;border: none;height: auto;float: none;width: 100%;max-width: 160px;\"\r\n                                                                            width=\"160\" />\r\n\r\n                                                                    </td>\r\n                                                                </tr>\r\n                                                            </table>\r\n\r\n                                                        </td>\r\n                                                    </tr>\r\n                                                </tbody>\r\n                                            </table>\r\n\r\n                                            <!--[if (!mso)&(!IE)]><!-->\r\n                                        </div>\r\n                                        <!--<![endif]-->\r\n                                    </div>\r\n                                </div>\r\n                                <!--[if (mso)|(IE)]></td><![endif]-->\r\n                                <!--[if (mso)|(IE)]><td align=\"center\" width=\"400\" style=\"width: 400px;padding: 0px;border-top: 0px solid transparent;border-left: 0px solid transparent;border-right: 0px solid transparent;border-bottom: 0px solid transparent;\" valign=\"top\"><![endif]-->\r\n                                <div class=\"u-col u-col-66p67\" style=\"max-width: 320px;min-width: 400px;display: table-cell;vertical-align: top;\">\r\n                                    <div style=\"height: 100%;width: 100% !important;\">\r\n                                        <!--[if (!mso)&(!IE)]><!-->\r\n                                        <div style=\"height: 100%; padding: 0px;border-top: 0px solid transparent;border-left: 0px solid transparent;border-right: 0px solid transparent;border-bottom: 0px solid transparent;\">\r\n                                            <!--<![endif]-->\r\n\r\n                                            <table style=\"font-family:'Lato',sans-serif;\" role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" border=\"0\">\r\n                                                <tbody>\r\n                                                    <tr>\r\n                                                        <td style=\"overflow-wrap:break-word;word-break:break-word;padding:44px 20px 20px;font-family:'Lato',sans-serif;\" align=\"left\">\r\n\r\n                                                            <div style=\"color: #ffffff; line-height: 140%; text-align: center; word-wrap: break-word;\">\r\n                                                                <p style=\"font-size: 14px; line-height: 140%;\"><span style=\"font-size: 24px; line-height: 33.6px; font-family: Ubuntu;\">TUNG <span style=\"line-height: 33.6px; font-size: 24px;\">SHOP</span></span>\r\n                                                                </p>\r\n                                                            </div>\r\n\r\n                                                        </td>\r\n                                                    </tr>\r\n                                                </tbody>\r\n                                            </table>\r\n\r\n                                            <!--[if (!mso)&(!IE)]><!-->\r\n                                        </div>\r\n                                        <!--<![endif]-->\r\n                                    </div>\r\n                                </div>\r\n                                <!--[if (mso)|(IE)]></td><![endif]-->\r\n                                <!--[if (mso)|(IE)]></tr></table></td></tr></table><![endif]-->\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n\r\n\r\n                    <div class=\"u-row-container\" style=\"padding: 0px 10px;background-color: rgba(255,255,255,0)\">\r\n                        <div class=\"u-row\" style=\"Margin: 0 auto;min-width: 320px;max-width: 600px;overflow-wrap: break-word;word-wrap: break-word;word-break: break-word;background-color: #f5f5f5;\">\r\n                            <div style=\"border-collapse: collapse;display: table;width: 100%;height: 100%;background-color: transparent;\">\r\n                                <!--[if (mso)|(IE)]><table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\"><tr><td style=\"padding: 0px 10px;background-color: rgba(255,255,255,0);\" align=\"center\"><table cellpadding=\"0\" cellspacing=\"0\" border=\"0\" style=\"width:600px;\"><tr style=\"background-color: #f5f5f5;\"><![endif]-->\r\n\r\n                                <!--[if (mso)|(IE)]><td align=\"center\" width=\"300\" style=\"width: 300px;padding: 0px;border-top: 0px solid transparent;border-left: 0px solid transparent;border-right: 0px solid transparent;border-bottom: 0px solid transparent;\" valign=\"top\"><![endif]-->\r\n                                <div class=\"u-col u-col-50\" style=\"max-width: 320px;min-width: 300px;display: table-cell;vertical-align: top;\">\r\n                                    <div style=\"height: 100%;width: 100% !important;\">\r\n                                        <!--[if (!mso)&(!IE)]><!-->\r\n                                        <div style=\"height: 100%; padding: 0px;border-top: 0px solid transparent;border-left: 0px solid transparent;border-right: 0px solid transparent;border-bottom: 0px solid transparent;\">\r\n                                            <!--<![endif]-->\r\n\r\n                                            <table style=\"font-family:'Lato',sans-serif;\" role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" border=\"0\">\r\n                                                <tbody>\r\n                                                    <tr>\r\n                                                        <td style=\"overflow-wrap:break-word;word-break:break-word;padding:35px 20px 10px;font-family:'Lato',sans-serif;\" align=\"left\">\r\n\r\n                                                            <div style=\"line-height: 120%; text-align: left; word-wrap: break-word;\">\r\n                                                                <p style=\"font-size: 14px; line-height: 120%;\"><span style=\"font-size: 24px; line-height: 28.8px; color: #18c197;\"><strong>Shipping Address</strong></span></p>\r\n                                                            </div>\r\n\r\n                                                        </td>\r\n                                                    </tr>\r\n                                                </tbody>\r\n                                            </table>\r\n\r\n                                            <table style=\"font-family:'Lato',sans-serif;\" role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" border=\"0\">\r\n                                                <tbody>\r\n                                                    <tr>\r\n                                                        <td style=\"overflow-wrap:break-word;word-break:break-word;padding:10px 20px 30px;font-family:'Lato',sans-serif;\" align=\"left\">\r\n\r\n                                                            <div style=\"color: #757575; line-height: 160%; text-align: left; word-wrap: break-word;\">\r\n                                                                <p style=\"font-size: 14px; line-height: 160%;\"><span style=\"font-size: 14px; line-height: 22.4px;\">"+newestOrder.ShipName + "</span></p>\r\n                                                                <p style=\"font-size: 14px; line-height: 160%;\"><span style=\"font-size: 14px; line-height: 22.4px;\">"+newestOrder.ShipAddress+"</span></p>\r\n                                                                <p style=\"font-size: 14px; line-height: 160%;\"><span style=\"font-size: 14px; line-height: 22.4px;\">"+ DateTime.Now.ToString("dddd, dd MMMM yyyy") + "</span></p>\r\n                                                            </div>\r\n\r\n                                                        </td>\r\n                                                    </tr>\r\n                                                </tbody>\r\n                                            </table>\r\n\r\n                                            <!--[if (!mso)&(!IE)]><!-->\r\n                                        </div>\r\n                                        <!--<![endif]-->\r\n                                    </div>\r\n                                </div>\r\n                                <!--[if (mso)|(IE)]></td><![endif]-->\r\n                                <!--[if (mso)|(IE)]><td align=\"center\" width=\"300\" style=\"width: 300px;padding: 0px;border-top: 0px solid transparent;border-left: 0px solid transparent;border-right: 0px solid transparent;border-bottom: 0px solid transparent;\" valign=\"top\"><![endif]-->\r\n                                <div class=\"u-col u-col-50\" style=\"max-width: 320px;min-width: 300px;display: table-cell;vertical-align: top;\">\r\n                                    <div style=\"height: 100%;width: 100% !important;\">\r\n                                        <!--[if (!mso)&(!IE)]><!-->\r\n                                        <div style=\"height: 100%; padding: 0px;border-top: 0px solid transparent;border-left: 0px solid transparent;border-right: 0px solid transparent;border-bottom: 0px solid transparent;\">\r\n                                            <!--<![endif]-->\r\n\r\n                                            <table style=\"font-family:'Lato',sans-serif;\" role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" border=\"0\">\r\n                                                <tbody>\r\n                                                    <tr>\r\n                                                        <td style=\"overflow-wrap:break-word;word-break:break-word;padding:35px 20px 10px;font-family:'Lato',sans-serif;\" align=\"left\">\r\n\r\n                                                            <div style=\"color: #333333; line-height: 120%; text-align: left; word-wrap: break-word;\">\r\n                                                                <p style=\"font-size: 14px; line-height: 120%;\"><strong><span style=\"font-size: 24px; line-height: 28.8px;\">Invoice Number</span></strong></p>\r\n                                                            </div>\r\n\r\n                                                        </td>\r\n                                                    </tr>\r\n                                                </tbody>\r\n                                            </table>\r\n\r\n                                            <table style=\"font-family:'Lato',sans-serif;\" role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" border=\"0\">\r\n                                                <tbody>\r\n                                                    <tr>\r\n                                                        <td style=\"overflow-wrap:break-word;word-break:break-word;padding:10px 20px 30px;font-family:'Lato',sans-serif;\" align=\"left\">\r\n\r\n                                                            <div style=\"color: #333333; line-height: 120%; text-align: left; word-wrap: break-word;\">\r\n                                                                <p style=\"font-size: 14px; line-height: 120%;\"><span style=\"font-size: 20px; line-height: 24px;\"><strong>#"+ newestOrder.OrderId.ToString() + "</strong></span></p>\r\n                                                            </div>\r\n\r\n                                                        </td>\r\n                                                    </tr>\r\n                                                </tbody>\r\n                                            </table>\r\n\r\n                                            <!--[if (!mso)&(!IE)]><!-->\r\n                                        </div>\r\n                                        <!--<![endif]-->\r\n                                    </div>\r\n                                </div>\r\n                                <!--[if (mso)|(IE)]></td><![endif]-->\r\n                                <!--[if (mso)|(IE)]></tr></table></td></tr></table><![endif]-->\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n\r\n\r\n                    <div class=\"u-row-container\" style=\"padding: 0px 10px;background-color: rgba(255,255,255,0)\">\r\n                        <div class=\"u-row\" style=\"Margin: 0 auto;min-width: 320px;max-width: 600px;overflow-wrap: break-word;word-wrap: break-word;word-break: break-word;background-color: #ffffff;\">\r\n                            <div style=\"border-collapse: collapse;display: table;width: 100%;height: 100%;background-color: transparent;\">\r\n                                <!--[if (mso)|(IE)]><table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\"><tr><td style=\"padding: 0px 10px;background-color: rgba(255,255,255,0);\" align=\"center\"><table cellpadding=\"0\" cellspacing=\"0\" border=\"0\" style=\"width:600px;\"><tr style=\"background-color: #ffffff;\"><![endif]-->\r\n\r\n                                <!--[if (mso)|(IE)]><td align=\"center\" width=\"600\" style=\"width: 600px;padding: 0px;border-top: 0px solid transparent;border-left: 0px solid transparent;border-right: 0px solid transparent;border-bottom: 0px solid transparent;\" valign=\"top\"><![endif]-->\r\n                                <div class=\"u-col u-col-100\" style=\"max-width: 320px;min-width: 600px;display: table-cell;vertical-align: top;\">\r\n                                    <div style=\"height: 100%;width: 100% !important;\">\r\n                                        <!--[if (!mso)&(!IE)]><!-->\r\n                                        <div style=\"height: 100%; padding: 0px;border-top: 0px solid transparent;border-left: 0px solid transparent;border-right: 0px solid transparent;border-bottom: 0px solid transparent;\">\r\n                                            <!--<![endif]-->\r\n\r\n                                            <table style=\"font-family:'Lato',sans-serif;\" role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" border=\"0\">\r\n                                                <tbody>\r\n                                                    <tr>\r\n                                                        <td style=\"overflow-wrap:break-word;word-break:break-word;padding:30px 20px 20px;font-family:'Lato',sans-serif;\" align=\"left\">\r\n\r\n                                                            <div style=\"color: #333333; line-height: 120%; text-align: left; word-wrap: break-word;\">\r\n                                                                <p style=\"font-size: 14px; line-height: 120%;\"><strong><span style=\"font-size: 24px; line-height: 28.8px;\">Purchesed Items</span></strong></p>\r\n                                                            </div>\r\n\r\n                                                        </td>\r\n                                                    </tr>\r\n                                                </tbody>\r\n                                            </table>\r\n\r\n                                            <table style=\"font-family:'Lato',sans-serif;\" role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" border=\"0\">\r\n                                                <tbody>\r\n                                                    <tr>\r\n                                                        <td style=\"overflow-wrap:break-word;word-break:break-word;padding:0px;font-family:'Lato',sans-serif;\" align=\"left\">\r\n\r\n                                                            <table height=\"0px\" align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"border-collapse: collapse;table-layout: fixed;border-spacing: 0;mso-table-lspace: 0pt;mso-table-rspace: 0pt;vertical-align: top;border-top: 1px solid #e3e3e3;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%\">\r\n                                                                <tbody>\r\n                                                                    <tr style=\"vertical-align: top\">\r\n                                                                        <td style=\"word-break: break-word;border-collapse: collapse !important;vertical-align: top;font-size: 0px;line-height: 0px;mso-line-height-rule: exactly;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%\">\r\n                                                                            <span>&#160;</span>\r\n                                                                        </td>\r\n                                                                    </tr>\r\n                                                                </tbody>\r\n                                                            </table>\r\n\r\n                                                        </td>\r\n                                                    </tr>\r\n                                                </tbody>\r\n                                            </table>\r\n\r\n                                            <!--[if (!mso)&(!IE)]><!-->\r\n                                        </div>\r\n                                        <!--<![endif]-->\r\n                                    </div>\r\n                                </div>\r\n                                <!--[if (mso)|(IE)]></td><![endif]-->\r\n                                <!--[if (mso)|(IE)]></tr></table></td></tr></table><![endif]-->\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n\r\n\r\n                    <div class=\"u-row-container\" style=\"padding: 0px 10px;background-color: rgba(255,255,255,0)\">\r\n                        <div class=\"u-row\" style=\"Margin: 0 auto;min-width: 320px;max-width: 600px;overflow-wrap: break-word;word-wrap: break-word;word-break: break-word;background-color: #ffffff;\">\r\n                            <div style=\"border-collapse: collapse;display: table;width: 100%;height: 100%;background-color: transparent;\">\r\n                                <!--[if (mso)|(IE)]><table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\"><tr><td style=\"padding: 0px 10px;background-color: rgba(255,255,255,0);\" align=\"center\"><table cellpadding=\"0\" cellspacing=\"0\" border=\"0\" style=\"width:600px;\"><tr style=\"background-color: #ffffff;\"><![endif]-->\r\n\r\n                                <!--[if (mso)|(IE)]><td align=\"center\" width=\"400\" style=\"width: 400px;padding: 0px;border-top: 0px solid transparent;border-left: 0px solid transparent;border-right: 0px solid transparent;border-bottom: 0px solid transparent;\" valign=\"top\"><![endif]-->\r\n                                <div class=\"u-col u-col-66p67\" style=\"max-width: 320px;min-width: 400px;display: table-cell;vertical-align: top;\">\r\n                                    <div style=\"height: 100%;width: 100% !important;\">\r\n                                        <!--[if (!mso)&(!IE)]><!-->\r\n                                        <div style=\"height: 100%; padding: 0px;border-top: 0px solid transparent;border-left: 0px solid transparent;border-right: 0px solid transparent;border-bottom: 0px solid transparent;\">\r\n                                            <!--<![endif]-->\r\n\r\n                                            <table style=\"font-family:'Lato',sans-serif;\" role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" border=\"0\">\r\n                                                <tbody>\r\n                                                    ";
            foreach(var item in get_order)
            {
                html +="<tr>\r\n                                                        <td style=\"overflow-wrap:break-word;word-break:break-word;padding:28px 20px 20px;font-family:'Lato',sans-serif;\" align=\"left\">\r\n\r\n                                                            <div style=\"color: #333333; line-height: 140%; text-align: left; word-wrap: break-word;\">\r\n                                                                <p style=\"font-size: 14px; line-height: 140%;\"><span style=\"font-size: 18px; line-height: 25.2px;\">"+item.Product.ProductName+"</span></p>\r\n                                                                <p style=\"font-size: 14px; line-height: 140%;\"><span style=\"font-size: 16px; line-height: 22.4px; color: #17c297;\">Quantity : "+item.Quantity+" x $"+ @String.Format("{0:.##}", item.UnitPrice) + "</span></p>\r\n                                                            </div>\r\n\r\n                                                        </td>\r\n                                                    </tr>\r\n";
            }
            html += "                                                </tbody>\r\n                                            </table>\r\n\r\n                                            <!--[if (!mso)&(!IE)]><!-->\r\n                                        </div>\r\n                                        <!--<![endif]-->\r\n                                    </div>\r\n                                </div>\r\n                                <!--[if (mso)|(IE)]></td><![endif]-->\r\n                                <!--[if (mso)|(IE)]><td align=\"center\" width=\"200\" style=\"width: 200px;padding: 0px;border-top: 0px solid transparent;border-left: 0px solid transparent;border-right: 0px solid transparent;border-bottom: 0px solid transparent;\" valign=\"top\"><![endif]-->\r\n                                <div class=\"u-col u-col-33p33\" style=\"max-width: 320px;min-width: 200px;display: table-cell;vertical-align: top;\">\r\n                                    <div style=\"height: 100%;width: 100% !important;\">\r\n                                        <!--[if (!mso)&(!IE)]><!-->\r\n                                        <div style=\"height: 100%; padding: 0px;border-top: 0px solid transparent;border-left: 0px solid transparent;border-right: 0px solid transparent;border-bottom: 0px solid transparent;\">\r\n                                            <!--<![endif]-->\r\n\r\n                                            <table style=\"font-family:'Lato',sans-serif;\" role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" border=\"0\">\r\n                                                <tbody>\r\n                                                    ";
            foreach(var item in get_order)
            {
                html += "<tr>\r\n                                                        <td style=\"overflow-wrap:break-word;word-break:break-word;padding:40px 20px 20px;font-family:'Lato',sans-serif;\" align=\"left\">\r\n\r\n                                                            <div style=\"color: #333333; line-height: 120%; text-align: left; word-wrap: break-word;\">\r\n                                                                <p style=\"font-size: 14px; line-height: 120%;\"><span style=\"font-size: 24px; line-height: 28.8px;\"><strong><span style=\"line-height: 28.8px; font-size: 24px;\">$"+ @String.Format("{0:.##}", item.UnitPrice * item.Quantity)+ "</span></strong>\r\n                                                                    </span>\r\n                                                                </p>\r\n                                                            </div>\r\n\r\n                                                        </td>\r\n                                                    </tr>\r\n";
            }

            html +=    "                                                </tbody>\r\n                                            </table>\r\n\r\n                                            <!--[if (!mso)&(!IE)]><!-->\r\n                                        </div>\r\n                                        <!--<![endif]-->\r\n                                    </div>\r\n                                </div>\r\n                                <!--[if (mso)|(IE)]></td><![endif]-->\r\n                                <!--[if (mso)|(IE)]></tr></table></td></tr></table><![endif]-->\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n\r\n\r\n                    <div class=\"u-row-container\" style=\"padding: 0px 10px;background-color: rgba(255,255,255,0)\">\r\n                        <div class=\"u-row\" style=\"Margin: 0 auto;min-width: 320px;max-width: 600px;overflow-wrap: break-word;word-wrap: break-word;word-break: break-word;background-color: #ffffff;\">\r\n                            <div style=\"border-collapse: collapse;display: table;width: 100%;height: 100%;background-color: transparent;\">\r\n                                <!--[if (mso)|(IE)]><table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\"><tr><td style=\"padding: 0px 10px;background-color: rgba(255,255,255,0);\" align=\"center\"><table cellpadding=\"0\" cellspacing=\"0\" border=\"0\" style=\"width:600px;\"><tr style=\"background-color: #ffffff;\"><![endif]-->\r\n\r\n                                <!--[if (mso)|(IE)]><td align=\"center\" width=\"600\" style=\"width: 600px;padding: 0px;border-top: 0px solid transparent;border-left: 0px solid transparent;border-right: 0px solid transparent;border-bottom: 0px solid transparent;\" valign=\"top\"><![endif]-->\r\n                                <div class=\"u-col u-col-100\" style=\"max-width: 320px;min-width: 600px;display: table-cell;vertical-align: top;\">\r\n                                    <div style=\"height: 100%;width: 100% !important;\">\r\n                                        <!--[if (!mso)&(!IE)]><!-->\r\n                                        <div style=\"height: 100%; padding: 0px;border-top: 0px solid transparent;border-left: 0px solid transparent;border-right: 0px solid transparent;border-bottom: 0px solid transparent;\">\r\n                                            <!--<![endif]-->\r\n\r\n                                            <table style=\"font-family:'Lato',sans-serif;\" role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" border=\"0\">\r\n                                                <tbody>\r\n                                                    <tr>\r\n                                                        <td style=\"overflow-wrap:break-word;word-break:break-word;padding:0px;font-family:'Lato',sans-serif;\" align=\"left\">\r\n\r\n                                                            <table height=\"0px\" align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"border-collapse: collapse;table-layout: fixed;border-spacing: 0;mso-table-lspace: 0pt;mso-table-rspace: 0pt;vertical-align: top;border-top: 1px solid #e3e3e3;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%\">\r\n                                                                <tbody>\r\n                                                                    <tr style=\"vertical-align: top\">\r\n                                                                        <td style=\"word-break: break-word;border-collapse: collapse !important;vertical-align: top;font-size: 0px;line-height: 0px;mso-line-height-rule: exactly;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%\">\r\n                                                                            <span>&#160;</span>\r\n                                                                        </td>\r\n                                                                    </tr>\r\n                                                                </tbody>\r\n                                                            </table>\r\n\r\n                                                        </td>\r\n                                                    </tr>\r\n                                                </tbody>\r\n                                            </table>\r\n\r\n                                            <!--[if (!mso)&(!IE)]><!-->\r\n                                        </div>\r\n                                        <!--<![endif]-->\r\n                                    </div>\r\n                                </div>\r\n                                <!--[if (mso)|(IE)]></td><![endif]-->\r\n                                <!--[if (mso)|(IE)]></tr></table></td></tr></table><![endif]-->\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n\r\n\r\n                    <div class=\"u-row-container\" style=\"padding: 0px 10px;background-color: rgba(255,255,255,0)\">\r\n                        <div class=\"u-row\" style=\"Margin: 0 auto;min-width: 320px;max-width: 600px;overflow-wrap: break-word;word-wrap: break-word;word-break: break-word;background-color: #ffffff;\">\r\n                            <div style=\"border-collapse: collapse;display: table;width: 100%;height: 100%;background-color: transparent;\">\r\n                                <!--[if (mso)|(IE)]><table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\"><tr><td style=\"padding: 0px 10px;background-color: rgba(255,255,255,0);\" align=\"center\"><table cellpadding=\"0\" cellspacing=\"0\" border=\"0\" style=\"width:600px;\"><tr style=\"background-color: #ffffff;\"><![endif]-->\r\n\r\n                                <!--[if (mso)|(IE)]><td align=\"center\" width=\"600\" style=\"width: 600px;padding: 0px;border-top: 0px solid transparent;border-left: 0px solid transparent;border-right: 0px solid transparent;border-bottom: 0px solid transparent;\" valign=\"top\"><![endif]-->\r\n                                <div class=\"u-col u-col-100\" style=\"max-width: 320px;min-width: 600px;display: table-cell;vertical-align: top;\">\r\n                                    <div style=\"height: 100%;width: 100% !important;\">\r\n                                        <!--[if (!mso)&(!IE)]><!-->\r\n                                        <div style=\"height: 100%; padding: 0px;border-top: 0px solid transparent;border-left: 0px solid transparent;border-right: 0px solid transparent;border-bottom: 0px solid transparent;\">\r\n                                            <!--<![endif]-->\r\n\r\n                                            <table style=\"font-family:'Lato',sans-serif;\" role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" border=\"0\">\r\n                                                <tbody>\r\n                                                    <tr>\r\n                                                        <td style=\"overflow-wrap:break-word;word-break:break-word;padding:0px;font-family:'Lato',sans-serif;\" align=\"left\">\r\n\r\n                                                            <table height=\"0px\" align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"border-collapse: collapse;table-layout: fixed;border-spacing: 0;mso-table-lspace: 0pt;mso-table-rspace: 0pt;vertical-align: top;border-top: 1px solid #e3e3e3;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%\">\r\n                                                                <tbody>\r\n                                                                    <tr style=\"vertical-align: top\">\r\n                                                                        <td style=\"word-break: break-word;border-collapse: collapse !important;vertical-align: top;font-size: 0px;line-height: 0px;mso-line-height-rule: exactly;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%\">\r\n                                                                            <span>&#160;</span>\r\n                                                                        </td>\r\n                                                                    </tr>\r\n                                                                </tbody>\r\n                                                            </table>\r\n\r\n                                                        </td>\r\n                                                    </tr>\r\n                                                </tbody>\r\n                                            </table>\r\n\r\n                                            <!--[if (!mso)&(!IE)]><!-->\r\n                                        </div>\r\n                                        <!--<![endif]-->\r\n                                    </div>\r\n                                </div>\r\n                                <!--[if (mso)|(IE)]></td><![endif]-->\r\n                                <!--[if (mso)|(IE)]></tr></table></td></tr></table><![endif]-->\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n\r\n\r\n                    <div class=\"u-row-container\" style=\"padding: 0px 10px;background-color: rgba(255,255,255,0)\">\r\n                        <div class=\"u-row\" style=\"Margin: 0 auto;min-width: 320px;max-width: 600px;overflow-wrap: break-word;word-wrap: break-word;word-break: break-word;background-color: #ffffff;\">\r\n                            <div style=\"border-collapse: collapse;display: table;width: 100%;height: 100%;background-color: transparent;\">\r\n                                <!--[if (mso)|(IE)]><table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\"><tr><td style=\"padding: 0px 10px;background-color: rgba(255,255,255,0);\" align=\"center\"><table cellpadding=\"0\" cellspacing=\"0\" border=\"0\" style=\"width:600px;\"><tr style=\"background-color: #ffffff;\"><![endif]-->\r\n\r\n                                <!--[if (mso)|(IE)]><td align=\"center\" width=\"600\" style=\"width: 600px;padding: 0px;border-top: 0px solid transparent;border-left: 0px solid transparent;border-right: 0px solid transparent;border-bottom: 0px solid transparent;\" valign=\"top\"><![endif]-->\r\n                                <div class=\"u-col u-col-100\" style=\"max-width: 320px;min-width: 600px;display: table-cell;vertical-align: top;\">\r\n                                    <div style=\"height: 100%;width: 100% !important;\">\r\n                                        <!--[if (!mso)&(!IE)]><!-->\r\n                                        <div style=\"height: 100%; padding: 0px;border-top: 0px solid transparent;border-left: 0px solid transparent;border-right: 0px solid transparent;border-bottom: 0px solid transparent;\">\r\n                                            <!--<![endif]-->\r\n\r\n                                            <table style=\"font-family:'Lato',sans-serif;\" role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" border=\"0\">\r\n                                                <tbody>\r\n                                                    <tr>\r\n                                                        <td style=\"overflow-wrap:break-word;word-break:break-word;padding:0px;font-family:'Lato',sans-serif;\" align=\"left\">\r\n\r\n                                                            <table height=\"0px\" align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"border-collapse: collapse;table-layout: fixed;border-spacing: 0;mso-table-lspace: 0pt;mso-table-rspace: 0pt;vertical-align: top;border-top: 1px solid #e3e3e3;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%\">\r\n                                                                <tbody>\r\n                                                                    <tr style=\"vertical-align: top\">\r\n                                                                        <td style=\"word-break: break-word;border-collapse: collapse !important;vertical-align: top;font-size: 0px;line-height: 0px;mso-line-height-rule: exactly;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%\">\r\n                                                                            <span>&#160;</span>\r\n                                                                        </td>\r\n                                                                    </tr>\r\n                                                                </tbody>\r\n                                                            </table>\r\n\r\n                                                        </td>\r\n                                                    </tr>\r\n                                                </tbody>\r\n                                            </table>\r\n\r\n                                            <!--[if (!mso)&(!IE)]><!-->\r\n                                        </div>\r\n                                        <!--<![endif]-->\r\n                                    </div>\r\n                                </div>\r\n                                <!--[if (mso)|(IE)]></td><![endif]-->\r\n                                <!--[if (mso)|(IE)]></tr></table></td></tr></table><![endif]-->\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n\r\n\r\n                    <div class=\"u-row-container\" style=\"padding: 0px 10px;background-color: rgba(255,255,255,0)\">\r\n                        <div class=\"u-row\" style=\"Margin: 0 auto;min-width: 320px;max-width: 600px;overflow-wrap: break-word;word-wrap: break-word;word-break: break-word;background-color: #ffffff;\">\r\n                            <div style=\"border-collapse: collapse;display: table;width: 100%;height: 100%;background-color: transparent;\">\r\n                                <!--[if (mso)|(IE)]><table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\"><tr><td style=\"padding: 0px 10px;background-color: rgba(255,255,255,0);\" align=\"center\"><table cellpadding=\"0\" cellspacing=\"0\" border=\"0\" style=\"width:600px;\"><tr style=\"background-color: #ffffff;\"><![endif]-->\r\n\r\n                                <!--[if (mso)|(IE)]><td align=\"center\" width=\"400\" style=\"width: 400px;padding: 0px;border-top: 0px solid transparent;border-left: 0px solid transparent;border-right: 0px solid transparent;border-bottom: 0px solid transparent;\" valign=\"top\"><![endif]-->\r\n                                <div class=\"u-col u-col-66p67\" style=\"max-width: 320px;min-width: 400px;display: table-cell;vertical-align: top;\">\r\n                                    <div style=\"height: 100%;width: 100% !important;\">\r\n                                        <!--[if (!mso)&(!IE)]><!-->\r\n                                        <div style=\"height: 100%; padding: 0px;border-top: 0px solid transparent;border-left: 0px solid transparent;border-right: 0px solid transparent;border-bottom: 0px solid transparent;\">\r\n                                            <!--<![endif]-->\r\n\r\n                                            <table style=\"font-family:'Lato',sans-serif;\" role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" border=\"0\">\r\n                                                <tbody>\r\n                                                    <tr>\r\n                                                        <td style=\"overflow-wrap:break-word;word-break:break-word;padding:28px 20px 25px;font-family:'Lato',sans-serif;\" align=\"left\">\r\n\r\n                                                            <div style=\"color: #333333; line-height: 140%; text-align: left; word-wrap: break-word;\">\r\n                                                                <p style=\"font-size: 14px; line-height: 140%;\"><span style=\"font-size: 24px; line-height: 33.6px;\"><strong><span style=\"line-height: 33.6px; font-size: 24px;\">Grand Total</span></strong>\r\n                                                                    </span>\r\n                                                                </p>\r\n                                                            </div>\r\n\r\n                                                        </td>\r\n                                                    </tr>\r\n                                                </tbody>\r\n                                            </table>\r\n\r\n                                            <!--[if (!mso)&(!IE)]><!-->\r\n                                        </div>\r\n                                        <!--<![endif]-->\r\n                                    </div>\r\n                                </div>\r\n                                <!--[if (mso)|(IE)]></td><![endif]-->\r\n                                <!--[if (mso)|(IE)]><td align=\"center\" width=\"200\" style=\"width: 200px;padding: 0px;border-top: 0px solid transparent;border-left: 0px solid transparent;border-right: 0px solid transparent;border-bottom: 0px solid transparent;\" valign=\"top\"><![endif]-->\r\n                                <div class=\"u-col u-col-33p33\" style=\"max-width: 320px;min-width: 200px;display: table-cell;vertical-align: top;\">\r\n                                    <div style=\"height: 100%;width: 100% !important;\">\r\n                                        <!--[if (!mso)&(!IE)]><!-->\r\n                                        <div style=\"height: 100%; padding: 0px;border-top: 0px solid transparent;border-left: 0px solid transparent;border-right: 0px solid transparent;border-bottom: 0px solid transparent;\">\r\n                                            <!--<![endif]-->\r\n\r\n                                            <table style=\"font-family:'Lato',sans-serif;\" role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" border=\"0\">\r\n                                                <tbody>\r\n                                                    <tr>\r\n                                                        <td style=\"overflow-wrap:break-word;word-break:break-word;padding:35px 20px 20px;font-family:'Lato',sans-serif;\" align=\"left\">\r\n\r\n                                                            <div style=\"color: #333333; line-height: 120%; text-align: left; word-wrap: break-word;\">\r\n                                                                <p style=\"font-size: 14px; line-height: 120%;\"><strong><span style=\"font-size: 30px; line-height: 36px;\">"+"$"+newestOrder.Freight+"</span></strong></p>\r\n                                                            </div>\r\n\r\n                                                        </td>\r\n                                                    </tr>\r\n                                                </tbody>\r\n                                            </table>\r\n\r\n                                            <!--[if (!mso)&(!IE)]><!-->\r\n                                        </div>\r\n                                        <!--<![endif]-->\r\n                                    </div>\r\n                                </div>\r\n                                <!--[if (mso)|(IE)]></td><![endif]-->\r\n                                <!--[if (mso)|(IE)]></tr></table></td></tr></table><![endif]-->\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n\r\n\r\n                    <div class=\"u-row-container\" style=\"padding: 0px 10px 20px;background-color: rgba(255,255,255,0)\">\r\n                        <div class=\"u-row\" style=\"Margin: 0 auto;min-width: 320px;max-width: 600px;overflow-wrap: break-word;word-wrap: break-word;word-break: break-word;background-color: #17c297;\">\r\n                            <div style=\"border-collapse: collapse;display: table;width: 100%;height: 100%;background-color: transparent;\">\r\n                                <!--[if (mso)|(IE)]><table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\"><tr><td style=\"padding: 0px 10px 20px;background-color: rgba(255,255,255,0);\" align=\"center\"><table cellpadding=\"0\" cellspacing=\"0\" border=\"0\" style=\"width:600px;\"><tr style=\"background-color: #17c297;\"><![endif]-->\r\n\r\n                                <!--[if (mso)|(IE)]><td align=\"center\" width=\"600\" style=\"width: 600px;padding: 0px;border-top: 0px solid transparent;border-left: 0px solid transparent;border-right: 0px solid transparent;border-bottom: 0px solid transparent;\" valign=\"top\"><![endif]-->\r\n                                <div class=\"u-col u-col-100\" style=\"max-width: 320px;min-width: 600px;display: table-cell;vertical-align: top;\">\r\n                                    <div style=\"height: 100%;width: 100% !important;\">\r\n                                        <!--[if (!mso)&(!IE)]><!-->\r\n                                        <div style=\"height: 100%; padding: 0px;border-top: 0px solid transparent;border-left: 0px solid transparent;border-right: 0px solid transparent;border-bottom: 0px solid transparent;\">\r\n                                            <!--<![endif]-->\r\n\r\n                                            <table style=\"font-family:'Lato',sans-serif;\" role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" border=\"0\">\r\n                                                <tbody>\r\n                                                    <tr>\r\n                                                        <td style=\"overflow-wrap:break-word;word-break:break-word;padding:30px 20px;font-family:'Lato',sans-serif;\" align=\"left\">\r\n\r\n                                                            <div style=\"color: #ffffff; line-height: 140%; text-align: center; word-wrap: break-word;\">\r\n                                                                <p style=\"font-size: 14px; line-height: 140%;\">Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum. Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque\r\n                                                                    laudantium, totam rem aperiam, eaque ipsa quae ab illo inventore veritatis.</p>\r\n                                                                <p style=\"font-size: 14px; line-height: 140%;\"> </p>\r\n                                                                <p style=\"font-size: 14px; line-height: 140%;\"> www. egamorft.c1.is</p>\r\n                                                            </div>\r\n\r\n                                                        </td>\r\n                                                    </tr>\r\n                                                </tbody>\r\n                                            </table>\r\n\r\n                                            <!--[if (!mso)&(!IE)]><!-->\r\n                                        </div>\r\n                                        <!--<![endif]-->\r\n                                    </div>\r\n                                </div>\r\n                                <!--[if (mso)|(IE)]></td><![endif]-->\r\n                                <!--[if (mso)|(IE)]></tr></table></td></tr></table><![endif]-->\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n\r\n\r\n                    <div class=\"u-row-container\" style=\"padding: 30px;background-color: #f0f0f0\">\r\n                        <div class=\"u-row\" style=\"Margin: 0 auto;min-width: 320px;max-width: 600px;overflow-wrap: break-word;word-wrap: break-word;word-break: break-word;background-color: transparent;\">\r\n                            <div style=\"border-collapse: collapse;display: table;width: 100%;height: 100%;background-color: transparent;\">\r\n                                <!--[if (mso)|(IE)]><table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\"><tr><td style=\"padding: 30px;background-color: #f0f0f0;\" align=\"center\"><table cellpadding=\"0\" cellspacing=\"0\" border=\"0\" style=\"width:600px;\"><tr style=\"background-color: transparent;\"><![endif]-->\r\n\r\n                                <!--[if (mso)|(IE)]><td align=\"center\" width=\"600\" style=\"width: 600px;padding: 0px;border-top: 0px solid transparent;border-left: 0px solid transparent;border-right: 0px solid transparent;border-bottom: 0px solid transparent;\" valign=\"top\"><![endif]-->\r\n                                <div class=\"u-col u-col-100\" style=\"max-width: 320px;min-width: 600px;display: table-cell;vertical-align: top;\">\r\n                                    <div style=\"height: 100%;width: 100% !important;\">\r\n                                        <!--[if (!mso)&(!IE)]><!-->\r\n                                        <div style=\"height: 100%; padding: 0px;border-top: 0px solid transparent;border-left: 0px solid transparent;border-right: 0px solid transparent;border-bottom: 0px solid transparent;\">\r\n                                            <!--<![endif]-->\r\n\r\n                                            <table style=\"font-family:'Lato',sans-serif;\" role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" border=\"0\">\r\n                                                <tbody>\r\n                                                    <tr>\r\n                                                        <td style=\"overflow-wrap:break-word;word-break:break-word;padding:20px;font-family:'Lato',sans-serif;\" align=\"left\">\r\n\r\n                                                            <div style=\"line-height: 120%; text-align: left; word-wrap: break-word;\">\r\n                                                                <div style=\"font-family: arial, helvetica, sans-serif;\"><span style=\"font-size: 12px; color: #999999; line-height: 14.4px;\">You received this email because you have bought some product in Tung Shop Inc.</span></div>\r\n                                                                <div style=\"font-family: arial, helvetica, sans-serif;\">&nbsp;</div>\r\n                                                                <div style=\"font-family: arial, helvetica, sans-serif;\"><span style=\"font-size: 12px; color: #999999; line-height: 14.4px;\"></span></div>\r\n                                                            </div>\r\n\r\n                                                        </td>\r\n                                                    </tr>\r\n                                                </tbody>\r\n                                            </table>\r\n\r\n                                            <!--[if (!mso)&(!IE)]><!-->\r\n                                        </div>\r\n                                        <!--<![endif]-->\r\n                                    </div>\r\n                                </div>\r\n                                <!--[if (mso)|(IE)]></td><![endif]-->\r\n                                <!--[if (mso)|(IE)]></tr></table></td></tr></table><![endif]-->\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n\r\n                    <!--[if (mso)|(IE)]></td></tr></table><![endif]-->\r\n                </td>\r\n            </tr>\r\n        </tbody>\r\n    </table>\r\n    <!--[if mso]></div><![endif]-->\r\n    <!--[if IE]></div><![endif]-->\r\n</body>\r\n\r\n</html>";
            


            var message = new Message(new string[]
            {
                get_account.Email
            }, "Order #" + newestOrder.OrderId.ToString() + " confirmation", html);

            _emailSender.SendEmail(message);

            var pdf = report.Render(renderFormat);
            return File(pdf, mimeType, "Invoice." + extension);

        }

        void SubReportProcessing(object sender, SubreportProcessingEventArgs args)
        {
            var detailsData = new DataTable();
            detailsData = GetOrderList().Select().CopyToDataTable();
            ReportDataSource ds = new ReportDataSource("dsOrder", detailsData);
            args.DataSources.Add(ds);
        }

        public DataTable GetOrderList()
        {
            var dt = new DataTable();
            dt.Columns.Add("Item");
            dt.Columns.Add("Qty");
            dt.Columns.Add("Price");
            dt.Columns.Add("Discount");
            dt.Columns.Add("Amount");
            DataRow row;

            var newestOrder = dBContext.Orders.OrderByDescending(p => p.OrderId).FirstOrDefault();
            var get_order = dBContext.OrderDetails.OrderByDescending(p => p.OrderId).Where(p => p.OrderId == newestOrder.OrderId).Include(x => x.Product).ToList();

            foreach (var item in get_order)
            {
                row = dt.NewRow();
                row["Item"] = item.Product.ProductName;
                row["Qty"] = item.Quantity;
                row["Price"] = @String.Format("{0:.##}", item.UnitPrice) + "$";
                row["Discount"] = item.Discount * 100 + "%";
                row["Amount"] = @String.Format("{0:.##}", item.UnitPrice * item.Quantity) + "$";
                dt.Rows.Add(row);
            }


            return dt;
        }

    }
}
